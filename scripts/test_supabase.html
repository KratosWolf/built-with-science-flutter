<!DOCTYPE html>
<html>
<head>
    <title>Built With Science - Database Setup</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: monospace; background: #1e1e1e; color: #ffffff; padding: 20px; }
        .log { background: #2d2d2d; padding: 15px; border-radius: 8px; margin: 10px 0; max-height: 400px; overflow-y: auto; }
        .success { color: #4caf50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        .info { color: #2196f3; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .primary { background: #2196f3; color: white; }
        .success-btn { background: #4caf50; color: white; }
    </style>
</head>
<body>
    <h1>üöÄ Built With Science - Database Setup</h1>
    <p>Testing Supabase connection and populating data...</p>
    
    <div>
        <button class="primary" onclick="testConnection()">Test Connection</button>
        <button class="primary" onclick="setupDatabase()">Setup Database</button>
        <button class="success-btn" onclick="clearLog()">Clear Log</button>
    </div>
    
    <div id="log" class="log"></div>

    <script>
        // Supabase configuration
        const supabaseUrl = 'https://gktvfldykmzhynqthbdn.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrdHZmbGR5a216aHlucXRoYmRuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5Nzg4NzAsImV4cCI6MjA3MTU1NDg3MH0.Nd2KdEGj8hQApxmTk8nkBM81R4ROJPhwRMtgPXadGVw';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div class="${type}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        async function testConnection() {
            log('üì° Testing Supabase connection...', 'info');
            try {
                const { count, error } = await supabase
                    .from('programs')
                    .select('*', { count: 'exact', head: true });

                if (error) throw error;
                log('‚úÖ Connection successful!', 'success');
                log(`üìä Current programs in database: ${count || 0}`, 'info');
            } catch (error) {
                log(`‚ùå Connection failed: ${error.message}`, 'error');
            }
        }

        async function setupDatabase() {
            log('üèóÔ∏è  Starting database setup...', 'info');
            
            try {
                // Step 1: Create programs
                await createPrograms();
                
                // Step 2: Create exercises
                await createExercises();
                
                log('üéâ Database setup completed!', 'success');
                log('Ready to test the Flutter app!', 'info');
                
            } catch (error) {
                log(`‚ùå Setup failed: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        }

        async function createPrograms() {
            log('üìã Creating sample programs...', 'info');
            
            const programs = [
                {
                    name: '3-Day Science-Based Full Body',
                    description: 'Optimal full-body routine for maximum muscle growth and strength. Perfect for beginners to intermediates.',
                    days_per_week: 3
                },
                {
                    name: '4-Day Upper/Lower Split',
                    description: 'Balanced upper and lower body split for intermediate to advanced trainees.',
                    days_per_week: 4
                },
                {
                    name: '5-Day Push/Pull/Legs',
                    description: 'High-frequency training for advanced lifters seeking maximum muscle development.',
                    days_per_week: 5
                }
            ];

            for (const program of programs) {
                try {
                    const { data, error } = await supabase
                        .from('programs')
                        .insert(program)
                        .select()
                        .single();

                    if (error) {
                        if (error.code === '23505') {
                            log(`‚ö†Ô∏è  Program "${program.name}" already exists`, 'warning');
                            continue;
                        }
                        throw error;
                    }

                    log(`‚úÖ Created program: ${program.name} (ID: ${data.id})`, 'success');
                    await createProgramDays(data.id, program.days_per_week, program.name);

                } catch (error) {
                    log(`‚ùå Error creating program ${program.name}: ${error.message}`, 'error');
                }
            }
        }

        async function createProgramDays(programId, daysPerWeek, programName) {
            const dayConfigs = {
                3: [
                    { day_index: 1, day_name: 'Full Body A' },
                    { day_index: 2, day_name: 'Full Body B' },
                    { day_index: 3, day_name: 'Full Body C' }
                ],
                4: [
                    { day_index: 1, day_name: 'Upper Body' },
                    { day_index: 2, day_name: 'Lower Body' },
                    { day_index: 3, day_name: 'Upper Body' },
                    { day_index: 4, day_name: 'Lower Body' }
                ],
                5: [
                    { day_index: 1, day_name: 'Push' },
                    { day_index: 2, day_name: 'Pull' },
                    { day_index: 3, day_name: 'Legs' },
                    { day_index: 4, day_name: 'Push' },
                    { day_index: 5, day_name: 'Pull' }
                ]
            };

            const days = dayConfigs[daysPerWeek];
            if (!days) return;

            for (const day of days) {
                try {
                    const { error } = await supabase
                        .from('program_days')
                        .insert({
                            program_id: programId,
                            day_index: day.day_index,
                            day_name: day.day_name
                        });

                    if (error) {
                        if (error.code === '23505') {
                            log(`  ‚ö†Ô∏è  Day "${day.day_name}" already exists for ${programName}`, 'warning');
                            continue;
                        }
                        throw error;
                    }

                    log(`  ‚úÖ Created day: ${day.day_name}`, 'success');
                } catch (error) {
                    log(`  ‚ùå Error creating day ${day.day_name}: ${error.message}`, 'error');
                }
            }
        }

        async function createExercises() {
            log('üí™ Creating exercises...', 'info');
            
            const exercises = [
                {
                    name: 'Barbell Back Squat',
                    muscle_groups: ['quadriceps', 'glutes', 'hamstrings', 'core'],
                    category: 'compound',
                    equipment: 'barbell'
                },
                {
                    name: 'Deadlift',
                    muscle_groups: ['hamstrings', 'glutes', 'erector_spinae', 'traps'],
                    category: 'compound',
                    equipment: 'barbell'
                },
                {
                    name: 'Bench Press',
                    muscle_groups: ['chest', 'triceps', 'anterior_deltoids'],
                    category: 'compound',
                    equipment: 'barbell'
                },
                {
                    name: 'Pull-ups',
                    muscle_groups: ['latissimus_dorsi', 'biceps', 'rear_deltoids'],
                    category: 'compound',
                    equipment: 'bodyweight'
                },
                {
                    name: 'Overhead Press',
                    muscle_groups: ['shoulders', 'triceps', 'core'],
                    category: 'compound',
                    equipment: 'barbell'
                },
                {
                    name: 'Dumbbell Bicep Curls',
                    muscle_groups: ['biceps'],
                    category: 'isolation',
                    equipment: 'dumbbells'
                },
                {
                    name: 'Tricep Dips',
                    muscle_groups: ['triceps'],
                    category: 'isolation',
                    equipment: 'bodyweight'
                },
                {
                    name: 'Lateral Raises',
                    muscle_groups: ['lateral_deltoids'],
                    category: 'isolation',
                    equipment: 'dumbbells'
                },
                {
                    name: 'Calf Raises',
                    muscle_groups: ['calves'],
                    category: 'isolation',
                    equipment: 'bodyweight'
                },
                {
                    name: 'Plank',
                    muscle_groups: ['core', 'shoulders'],
                    category: 'isolation',
                    equipment: 'bodyweight'
                }
            ];

            for (const exercise of exercises) {
                try {
                    const { data, error } = await supabase
                        .from('exercises')
                        .insert(exercise)
                        .select()
                        .single();

                    if (error) {
                        if (error.code === '23505') {
                            log(`‚ö†Ô∏è  Exercise "${exercise.name}" already exists`, 'warning');
                            continue;
                        }
                        throw error;
                    }

                    log(`‚úÖ Created exercise: ${exercise.name} (ID: ${data.id})`, 'success');
                    await createExerciseVariations(data.id, exercise.name);

                } catch (error) {
                    log(`‚ùå Error creating exercise ${exercise.name}: ${error.message}`, 'error');
                }
            }
        }

        async function createExerciseVariations(exerciseId, exerciseName) {
            const variations = getVariationsForExercise(exerciseName);
            
            for (let i = 0; i < variations.length; i++) {
                const variation = variations[i];
                try {
                    const { error } = await supabase
                        .from('exercise_variations')
                        .insert({
                            exercise_id: exerciseId,
                            variation_index: i + 1,
                            variation_name: variation.name,
                            youtube_url: variation.youtube_url,
                            is_primary: i === 0,
                            difficulty_level: variation.difficulty
                        });

                    if (error) {
                        if (error.code === '23505') {
                            log(`  ‚ö†Ô∏è  Variation "${variation.name}" already exists`, 'warning');
                            continue;
                        }
                        throw error;
                    }

                    log(`  ‚úÖ Created variation: ${variation.name}`, 'success');
                } catch (error) {
                    log(`  ‚ùå Error creating variation ${variation.name}: ${error.message}`, 'error');
                }
            }
        }

        function getVariationsForExercise(exerciseName) {
            const variations = {
                'Barbell Back Squat': [
                    { name: 'High Bar Back Squat', youtube_url: 'https://www.youtube.com/watch?v=ultWZbUMPL8', difficulty: 'intermediate' },
                    { name: 'Low Bar Back Squat', youtube_url: 'https://www.youtube.com/watch?v=vmNPOjaGrVE', difficulty: 'advanced' },
                    { name: 'Goblet Squat', youtube_url: 'https://www.youtube.com/watch?v=MeIiIdhvXT4', difficulty: 'beginner' }
                ],
                'Deadlift': [
                    { name: 'Conventional Deadlift', youtube_url: 'https://www.youtube.com/watch?v=op9kVnSso6Q', difficulty: 'intermediate' },
                    { name: 'Sumo Deadlift', youtube_url: 'https://www.youtube.com/watch?v=6ucdKlZkZCU', difficulty: 'intermediate' },
                    { name: 'Romanian Deadlift', youtube_url: 'https://www.youtube.com/watch?v=jEy_czb3RKA', difficulty: 'beginner' }
                ],
                'Bench Press': [
                    { name: 'Flat Barbell Bench Press', youtube_url: 'https://www.youtube.com/watch?v=gRVjAtPip0Y', difficulty: 'intermediate' },
                    { name: 'Incline Barbell Bench Press', youtube_url: 'https://www.youtube.com/watch?v=DbFgADa2PL8', difficulty: 'intermediate' },
                    { name: 'Dumbbell Bench Press', youtube_url: 'https://www.youtube.com/watch?v=QsYre__-aro', difficulty: 'beginner' }
                ],
                'Pull-ups': [
                    { name: 'Standard Pull-up', youtube_url: 'https://www.youtube.com/watch?v=eGo4IYlbE5g', difficulty: 'intermediate' },
                    { name: 'Chin-ups', youtube_url: 'https://www.youtube.com/watch?v=jfzjti-f2ME', difficulty: 'beginner' },
                    { name: 'Wide Grip Pull-ups', youtube_url: 'https://www.youtube.com/watch?v=iU3LfJWNBgA', difficulty: 'advanced' }
                ]
            };

            return variations[exerciseName] || [
                { name: exerciseName, youtube_url: 'https://www.youtube.com/watch?v=dQw4w9WgXcQ', difficulty: 'intermediate' }
            ];
        }

        // Auto-test connection on load
        window.onload = function() {
            log('üöÄ Built With Science Database Setup Tool', 'info');
            log('Click "Test Connection" to verify Supabase access', 'info');
            log('Click "Setup Database" to populate sample data', 'info');
        };
    </script>
</body>
</html>